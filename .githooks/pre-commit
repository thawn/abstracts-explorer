#!/bin/bash
# Pre-commit hook to ensure vendor files are up-to-date and code passes linting

set -e  # Exit on any error

# Activate virtual environment if it exists
if [ -f ".venv/bin/activate" ]; then
    source .venv/bin/activate
fi

# Check if HTML, JS, or CSS files are being committed
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR -- \
    'src/abstracts_explorer/web_ui/templates/*.html' \
    'src/abstracts_explorer/web_ui/static/*.js' \
    'src/abstracts_explorer/web_ui/static/*.css' \
    'tailwind.config.js' \
    2>/dev/null)

if [ -n "$STAGED_FILES" ]; then
    echo "Detected changes in web UI files:"
    echo "$STAGED_FILES"
    echo "Running npm run install:vendor to ensure vendor files are up-to-date..."
    npm run install:vendor
    
    # Check if vendor files were modified
    VENDOR_CHANGES=$(git diff --name-only src/abstracts_explorer/web_ui/static/vendor/ 2>/dev/null)
    
    if [ -n "$VENDOR_CHANGES" ]; then
        echo ""
        echo "Vendor files were updated. Please stage these changes:"
        echo "$VENDOR_CHANGES"
        echo ""
        echo "Run: git add src/abstracts_explorer/web_ui/static/vendor/"
        echo "Then: git commit"
        exit 1
    fi
fi

# Check if Python files are being committed
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '(src|tests)/.*\.py$' || true)

if [ -n "$PYTHON_FILES" ]; then
    echo ""
    echo "üîç Running linting checks on Python files..."
    
    # Check if black is available and run it
    if command -v black &> /dev/null; then
        echo "  ‚úì Running black..."
        if ! black --check $PYTHON_FILES 2>/dev/null; then
            echo ""
            echo "‚ùå Black formatting check failed! Auto-formatting files..."
            black $PYTHON_FILES
            echo ""
            echo "‚úÖ Files have been auto-formatted with black."
            echo "   Please stage the formatted files and commit again:"
            echo "   git add $PYTHON_FILES"
            exit 1
        fi
        echo "  ‚úì Black formatting check passed"
    else
        echo "  ‚ö†Ô∏è  black not found, skipping black check"
        echo "     Install with: uv sync --extra dev"
    fi
    
    # Check if ruff is available
    if command -v ruff &> /dev/null; then
        echo "  ‚úì Running ruff..."
        if ! ruff check src/ tests/ --quiet; then
            echo ""
            echo "‚ùå Ruff linting failed! Please fix the errors above."
            echo "   You can auto-fix many issues with: ruff check src/ tests/ --fix"
            exit 1
        fi
        echo "  ‚úì Ruff passed"
    else
        echo "  ‚ö†Ô∏è  ruff not found, skipping ruff check"
        echo "     Install with: uv pip install --system ruff"
    fi
    
    # Check if mypy is available
    if command -v mypy &> /dev/null; then
        echo "  ‚úì Running mypy..."
        if ! mypy src/ --ignore-missing-imports 2>&1 | tail -1 | grep -q "Success"; then
            echo ""
            echo "‚ùå Mypy type checking failed! Please fix the errors above."
            exit 1
        fi
        echo "  ‚úì Mypy passed"
    else
        echo "  ‚ö†Ô∏è  mypy not found, skipping type check"
        echo "     Install with: uv pip install --system mypy types-requests"
    fi
    
    echo ""
    echo "‚úÖ All linting checks passed!"
fi

exit 0
