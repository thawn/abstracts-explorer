# Docker Compose configuration for Abstracts Explorer
# Compatible with Docker Compose v2+ and Podman Compose

services:
  # Main Abstracts Explorer application
  abstracts-explorer:
    image: ghcr.io/thawn/abstracts-explorer:latest
    container_name: abstracts-explorer
    ports:
      - "5000:5000"
    volumes:
      # Persist data directory
      - abstracts-data:/app/data
      # Optional: mount custom .env file
      # - ./.env:/app/.env:ro
    environment:
      # Database configuration - using PostgreSQL
      - DATA_DIR=/app/data
      - PAPER_DB=postgresql://abstracts:abstracts_password@postgres:5432/abstracts
      
      # Embeddings configuration - using ChromaDB service
      - EMBEDDING_DB_URL=http://chromadb:8000
      - COLLECTION_NAME=papers
      
      # LLM Backend configuration
      # Option 1: Use external service (e.g., blablador)
      - LLM_BACKEND_URL=https://api.helmholtz-blablador.fz-juelich.de
      - LLM_BACKEND_AUTH_TOKEN=${LLM_BACKEND_AUTH_TOKEN}

      # Option 2: Use host's LM Studio (requires host.docker.internal or host network)
      # - LLM_BACKEND_URL=http://host.docker.internal:1234
      
      # Models
      # For Blablador
      - CHAT_MODEL=alias-fast
      - EMBEDDING_MODEL=alias-embeddings

      # For host's LM Studio we recommend
      # - CHAT_MODEL=gemma-3-4b-it-qat
      # - EMBEDDING_MODEL=text-embedding-qwen3-embedding-4b

      # RAG settings
      - MAX_CONTEXT_PAPERS=5
      - ENABLE_QUERY_REWRITING=true
      - QUERY_SIMILARITY_THRESHOLD=0.7
    
    # Use host network mode for easier access to host's LM Studio
    # Uncomment if using LM Studio on host
    # network_mode: host
    
    # Depends on database services
    depends_on:
      chromadb:
        condition: service_healthy
      postgres:
        condition: service_healthy
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ChromaDB vector database service
  chromadb:
    image: chromadb/chroma:latest
    container_name: abstracts-chromadb
    volumes:
      - chromadb-data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/8000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # PostgreSQL database service
  postgres:
    image: postgres:16-alpine
    container_name: abstracts-postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=abstracts
      - POSTGRES_USER=abstracts
      - POSTGRES_PASSWORD=abstracts_password
      # Change password in production!
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U abstracts"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  # Named volumes for persistent data
  abstracts-data:
    driver: local
  chromadb-data:
    driver: local
  postgres-data:
    driver: local

networks:
  default:
    name: abstracts-network
